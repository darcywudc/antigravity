<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenSeesç»¼åˆåˆ†æ - é™åŠ›+åŠ¨åŠ›</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 1900px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 15px;
        }

        h1 {
            font-size: 1.3rem;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 320px 1fr 1fr;
            gap: 15px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
        }

        .panel h3 {
            font-size: 0.9rem;
            color: #00d4ff;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel h3.static {
            color: #ffa502;
        }

        .panel h3.dynamic {
            color: #00ff88;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 3px;
        }

        input,
        select {
            width: 100%;
            padding: 6px 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            color: #fff;
            font-size: 0.8rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .slider-group {
            margin-bottom: 8px;
        }

        .slider-group label {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: #888;
        }

        .slider-group input[type="range"] {
            width: 100%;
            margin-top: 3px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .btn-static {
            background: linear-gradient(135deg, #ffa502, #ff6b6b);
            color: #fff;
        }

        .btn-dynamic {
            background: linear-gradient(135deg, #00d4ff, #00ff88);
            color: #0a0a1a;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .result-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 10px;
            text-align: center;
        }

        .result-card .label {
            font-size: 0.65rem;
            color: #888;
        }

        .result-card .value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #00d4ff;
        }

        .result-card .unit {
            font-size: 0.65rem;
            color: #666;
        }

        .result-card.highlight {
            border: 1px solid #00ff88;
        }

        .result-card.warning {
            border: 1px solid #ffa502;
        }

        .support-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            font-size: 0.7rem;
        }

        .support-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 6px;
            border-radius: 4px;
            text-align: center;
        }

        .support-item .name {
            color: #00d4ff;
            font-weight: bold;
        }

        .support-item .val {
            color: #00ff88;
        }

        .chart-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .chart-container h4 {
            font-size: 0.75rem;
            color: #00ff88;
            margin-bottom: 6px;
        }

        canvas {
            width: 100% !important;
            height: 150px !important;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .status-bar {
            position: fixed;
            bottom: 15px;
            right: 15px;
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 6px;
            font-size: 0.75rem;
        }

        .status-bar.connected {
            border-left: 3px solid #00ff88;
        }

        .status-bar.disconnected {
            border-left: 3px solid #ff6b6b;
        }

        .info-text {
            font-size: 0.7rem;
            color: #666;
            margin-top: 4px;
        }

        .ecc-display {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            margin-top: 10px;
        }

        .ecc-diagram {
            width: 60px;
            height: 60px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            position: relative;
            background: rgba(0, 0, 0, 0.3);
        }

        .ecc-point {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        .ecc-point.stiffness {
            background: #00ff88;
        }

        .ecc-point.mass {
            background: #ff6b6b;
        }

        .arrow {
            color: #00d4ff;
            font-size: 1.5rem;
        }

        .gm-presets {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
        }

        .gm-chip {
            padding: 4px 8px;
            font-size: 0.7rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            cursor: pointer;
        }

        .gm-chip:hover {
            background: rgba(0, 212, 255, 0.2);
        }

        .gm-chip.active {
            background: #00d4ff;
            color: #0a0a1a;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>ğŸ”¬ OpenSeesç»¼åˆåˆ†æ - é™åŠ›å­¦ â†’ åŠ¨åŠ›å­¦</h1>
            <div class="status-bar disconnected" id="status-bar">æ£€æŸ¥è¿æ¥...</div>
        </header>

        <div class="main-layout">
            <!-- å·¦ä¾§ï¼šå‚æ•°è®¾ç½® -->
            <div class="sidebar">
                <div class="panel">
                    <h3>ğŸ“ æ”¯åº§å‚æ•° <button onclick="toggleBearingMode()" id="btn-mode"
                            style="float:right;font-size:0.65rem;padding:2px 6px;">åˆ‡æ¢æ¨¡å¼</button></h3>

                    <!-- æ¨¡å¼1: ç‰©ç†å‚æ•°ï¼ˆè‡ªåŠ¨è®¡ç®—åˆšåº¦ï¼‰-->
                    <div id="mode-physical">
                        <div class="form-row">
                            <div class="form-group">
                                <label>è¾¹ç¼˜æ”¯åº§ç›´å¾„ (mm)</label>
                                <input type="number" id="edge-diameter" value="44" step="1"
                                    onchange="calcBearingStiffness()">
                            </div>
                            <div class="form-group">
                                <label>ä¸­é—´æ”¯åº§ç›´å¾„ (mm)</label>
                                <input type="number" id="mid-diameter" value="55" step="1"
                                    onchange="calcBearingStiffness()">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>æ©¡èƒ¶å±‚æ•° (è¾¹ç¼˜/ä¸­é—´)</label>
                                <input type="number" id="edge-layers" value="10" step="1" min="1"
                                    onchange="calcBearingStiffness()">
                            </div>
                            <div class="form-group">
                                <label>ä¸­é—´æ”¯åº§å±‚æ•°</label>
                                <input type="number" id="mid-layers" value="10" step="1" min="1"
                                    onchange="calcBearingStiffness()">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>å•å±‚æ©¡èƒ¶åšåº¦ (mm)</label>
                                <input type="number" id="rubber-layer-t" value="2" step="0.5" min="0.5"
                                    onchange="calcBearingStiffness()">
                            </div>
                            <div class="form-group">
                                <label>å‰ªåˆ‡æ¨¡é‡ G (MPa)</label>
                                <input type="number" id="shear-modulus" value="0.4" step="0.1" min="0.1"
                                    onchange="calcBearingStiffness()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>å±ˆæœå‹åº”åŠ› Ïƒcr (MPa)</label>
                            <input type="number" id="yield-pressure" value="30" step="1" min="1"
                                onchange="calcBearingStiffness()">
                        </div>
                        <p class="info-text"
                            style="background:rgba(0,212,255,0.1);padding:5px;border-radius:5px;margin-top:8px;">
                            <strong>è®¡ç®—å…¬å¼:</strong><br>
                            <span style="font-size:0.65rem;color:#aaa;">
                                å½¢çŠ¶ç³»æ•° S = D/(4tr)<br>
                                Khâ‚€ = GÂ·A/Tr &nbsp; Kv = 6GSÂ²A/Tr<br>
                                <span style="color:#00ff88;">Kh = Khâ‚€Ã—(1-(Ïƒ/Ïƒcr)Â²)</span>
                            </span>
                        </p>
                        <p class="info-text"
                            style="background:rgba(255,165,2,0.1);padding:5px;border-radius:5px;margin-top:5px;">
                            <strong>è®¡ç®—ç»“æœ:</strong><br>
                            è¾¹ç¼˜: Kv=<span id="calc-edge-kv">--</span> kN/m, Khâ‚€=<span id="calc-edge-kh">--</span>
                            kN/m<br>
                            ä¸­é—´: Kv=<span id="calc-mid-kv">--</span> kN/m, Khâ‚€=<span id="calc-mid-kh">--</span> kN/m
                        </p>
                    </div>

                    <!-- æ¨¡å¼2: ç›´æ¥è¾“å…¥åˆšåº¦ -->
                    <div id="mode-direct" style="display:none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>è¾¹ç¼˜æ”¯åº§Kv (kN/m)</label>
                                <input type="number" id="edge-kv" value="5520" step="100">
                            </div>
                            <div class="form-group">
                                <label>ä¸­é—´æ”¯åº§Kv (kN/m)</label>
                                <input type="number" id="mid-kv" value="13475" step="100">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>è¾¹ç¼˜æ”¯åº§Kh (kN/m)</label>
                                <input type="number" id="edge-kh" value="55.2" step="1">
                            </div>
                            <div class="form-group">
                                <label>ä¸­é—´æ”¯åº§Kh (kN/m)</label>
                                <input type="number" id="mid-kh" value="134.75" step="1">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h3>ç»“æ„å¸ƒç½®</h3>
                    <div class="form-group">
                        <label>æ€»é‡é‡ (kN)</label>
                        <input type="number" id="total-weight" value="85.58" step="0.1">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Xæ–¹å‘é—´è· (m)</label>
                            <input type="number" id="spacing-x" value="0.6" step="0.1" min="0.1">
                        </div>
                        <div class="form-group">
                            <label>Yæ–¹å‘é—´è· (m)</label>
                            <input type="number" id="spacing-y" value="0.2" step="0.05" min="0.05">
                        </div>
                    </div>
                    <p class="info-text">å¸ƒç½®: 2è¡ŒÃ—3åˆ—, å…±6ä¸ªæ”¯åº§</p>
                </div>

                <div class="panel">
                    <h3 class="static">âš™ é«˜åº¦è°ƒæ•´ï¼ˆé™åŠ›å­¦è¾“å…¥ï¼‰</h3>
                    <div class="slider-group">
                        <label>æ”¯åº§8 (å·¦ä¸Š) <span id="h8-val">0.0</span> mm</label>
                        <input type="range" id="h8" min="-3" max="3" step="0.1" value="0">
                    </div>
                    <div class="slider-group">
                        <label>æ”¯åº§11 (ä¸­ä¸Š) <span id="h11-val">0.0</span> mm</label>
                        <input type="range" id="h11" min="-3" max="3" step="0.1" value="0">
                    </div>
                    <div class="slider-group">
                        <label>æ”¯åº§25 (å³ä¸Š) <span id="h25-val">0.0</span> mm</label>
                        <input type="range" id="h25" min="-3" max="3" step="0.1" value="0">
                    </div>
                    <div class="slider-group">
                        <label>æ”¯åº§4 (å·¦ä¸‹) <span id="h4-val">0.0</span> mm</label>
                        <input type="range" id="h4" min="-3" max="3" step="0.1" value="0">
                    </div>
                    <div class="slider-group">
                        <label>æ”¯åº§16 (ä¸­ä¸‹) <span id="h16-val">0.0</span> mm</label>
                        <input type="range" id="h16" min="-3" max="3" step="0.1" value="0">
                    </div>
                    <div class="slider-group">
                        <label>æ”¯åº§30 (å³ä¸‹) <span id="h30-val">0.0</span> mm</label>
                        <input type="range" id="h30" min="-3" max="3" step="0.1" value="0">
                    </div>
                    <button class="btn btn-static" id="btn-static">ğŸ“ è¿è¡Œé™åŠ›åˆ†æ</button>
                </div>

                <div class="panel">
                    <h3 class="dynamic">ğŸŒŠ åœ°éœ‡åŠ¨è¾“å…¥</h3>
                    <div class="gm-presets">
                        <div class="gm-chip active" data-gm="sine">æ­£å¼¦æ³¢</div>
                        <div class="gm-chip" data-gm="elcentro">El Centro</div>
                        <div class="gm-chip" data-gm="pulse">è„‰å†²</div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>PGA (g)</label>
                            <input type="number" id="pga" value="0.2" step="0.05" min="0.05" max="1.0">
                        </div>
                        <div class="form-group">
                            <label>ä¸»å‘¨æœŸ (s)</label>
                            <input type="number" id="gm-period" value="2.0" step="0.1" min="0.1" max="5">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>æŒæ—¶ (s)</label>
                            <input type="number" id="duration" value="5" step="1" min="3" max="15">
                        </div>
                        <div class="form-group">
                            <label>dt (s)</label>
                            <input type="number" id="dt" value="0.02" step="0.01">
                        </div>
                    </div>
                    <button class="btn btn-dynamic" id="btn-dynamic" disabled>ğŸŒŠ è¿è¡ŒåŠ¨åŠ›åˆ†æï¼ˆéœ€å…ˆè¿è¡Œé™åŠ›ï¼‰</button>
                    <p class="info-text" id="status-text">è¯·å…ˆè¿è¡Œé™åŠ›åˆ†æ</p>
                </div>
            </div>

            <!-- ä¸­é—´ï¼šé™åŠ›å­¦ç»“æœ -->
            <div class="static-results">
                <div class="panel">
                    <h3 class="static">é™åŠ›å­¦åˆ†æç»“æœ</h3>
                    <div class="result-grid">
                        <div class="result-card">
                            <div class="label">åˆšåº¦ä¸­å¿ƒ X</div>
                            <div class="value" id="sc-x">--</div>
                            <div class="unit">m</div>
                        </div>
                        <div class="result-card">
                            <div class="label">åˆšåº¦ä¸­å¿ƒ Y</div>
                            <div class="value" id="sc-y">--</div>
                            <div class="unit">m</div>
                        </div>
                        <div class="result-card warning">
                            <div class="label">åå¿ƒè·</div>
                            <div class="value" id="ecc">--</div>
                            <div class="unit">m</div>
                        </div>
                        <div class="result-card">
                            <div class="label">æ€»åˆšåº¦ Kh</div>
                            <div class="value" id="total-kh">--</div>
                            <div class="unit">kN/m</div>
                        </div>
                    </div>
                    <div class="ecc-display">
                        <div class="ecc-diagram" id="ecc-diagram">
                            <div class="ecc-point stiffness" id="ecc-sc" style="left:50%;top:50%;"></div>
                            <div class="ecc-point mass" style="left:50%;top:50%;"></div>
                        </div>
                        <div style="font-size:0.7rem;">
                            <div><span style="color:#00ff88;">â—</span> åˆšåº¦ä¸­å¿ƒ(ç­‰æ•ˆ)</div>
                            <div><span style="color:#ff6b6b;">â—</span> è´¨å¿ƒ(0,0)</div>
                            <div style="color:#ffa502;margin-top:5px;" id="ecc-text">åå¿ƒ: --</div>
                        </div>
                        <div class="arrow">â†’</div>
                        <div style="font-size:0.7rem;color:#00d4ff;">åŠ¨åŠ›å­¦åˆ†æ<br>å°†ä½¿ç”¨æ­¤åå¿ƒ</div>
                    </div>
                </div>

                <div class="panel">
                    <h3 class="static">æ”¯åº§ååŠ› (kN)</h3>
                    <div class="support-grid" id="reaction-grid">
                        <div class="support-item">
                            <div class="name">æ”¯åº§8</div>
                            <div class="val" id="r8">--</div>
                        </div>
                        <div class="support-item">
                            <div class="name">æ”¯åº§11</div>
                            <div class="val" id="r11">--</div>
                        </div>
                        <div class="support-item">
                            <div class="name">æ”¯åº§25</div>
                            <div class="val" id="r25">--</div>
                        </div>
                        <div class="support-item">
                            <div class="name">æ”¯åº§4</div>
                            <div class="val" id="r4">--</div>
                        </div>
                        <div class="support-item">
                            <div class="name">æ”¯åº§16</div>
                            <div class="val" id="r16">--</div>
                        </div>
                        <div class="support-item">
                            <div class="name">æ”¯åº§30</div>
                            <div class="val" id="r30">--</div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h3 class="dynamic">åŠ¨åŠ›ç‰¹æ€§</h3>
                    <div class="result-grid">
                        <div class="result-card">
                            <div class="label">å¹³åŠ¨å‘¨æœŸ Tx</div>
                            <div class="value" id="period-x">--</div>
                            <div class="unit">s</div>
                        </div>
                        <div class="result-card">
                            <div class="label">æ‰­è½¬å‘¨æœŸ TÎ¸</div>
                            <div class="value" id="period-theta">--</div>
                            <div class="unit">s</div>
                        </div>
                        <div class="result-card">
                            <div class="label">å‘¨æœŸæ¯” TÎ¸/Tx</div>
                            <div class="value" id="period-ratio">--</div>
                            <div class="unit"></div>
                        </div>
                        <div class="result-card highlight">
                            <div class="label">æ”¾å¤§ç³»æ•°</div>
                            <div class="value" id="amp">--</div>
                            <div class="unit">å€</div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h3 class="dynamic">æ”¯åº§å˜å½¢å³°å€¼ (mm)</h3>
                    <div class="support-grid" id="bearing-grid">
                        <div class="support-item">
                            <div class="name">æ”¯åº§8</div>
                            <div class="val" id="b8">--</div>
                        </div>
                        <div class="support-item">
                            <div class="name">æ”¯åº§11</div>
                            <div class="val" id="b11">--</div>
                        </div>
                        <div class="support-item">
                            <div class="name">æ”¯åº§25</div>
                            <div class="val" id="b25">--</div>
                        </div>
                        <div class="support-item">
                            <div class="name">æ”¯åº§4</div>
                            <div class="val" id="b4">--</div>
                        </div>
                        <div class="support-item">
                            <div class="name">æ”¯åº§16</div>
                            <div class="val" id="b16">--</div>
                        </div>
                        <div class="support-item">
                            <div class="name">æ”¯åº§30</div>
                            <div class="val" id="b30">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šåŠ¨åŠ›å­¦ç»“æœ -->
            <div class="dynamic-results">
                <div class="panel">
                    <h3 class="dynamic">åŠ¨åŠ›å­¦å³°å€¼å“åº”</h3>
                    <div class="result-grid">
                        <div class="result-card highlight">
                            <div class="label">è´¨å¿ƒä½ç§»X</div>
                            <div class="value" id="max-disp-x">--</div>
                            <div class="unit">mm</div>
                        </div>
                        <div class="result-card highlight">
                            <div class="label">è´¨å¿ƒä½ç§»Y</div>
                            <div class="value" id="max-disp-y">--</div>
                            <div class="unit">mm</div>
                        </div>
                        <div class="result-card">
                            <div class="label">æœ€å¤§åŠ é€Ÿåº¦</div>
                            <div class="value" id="max-accel">--</div>
                            <div class="unit">g</div>
                        </div>
                        <div class="result-card">
                            <div class="label">æœ€å¤§è½¬è§’</div>
                            <div class="value" id="max-rot">--</div>
                            <div class="unit">mrad</div>
                        </div>
                    </div>
                    <div class="result-grid" style="margin-top:8px;">
                        <div class="result-card">
                            <div class="label">çŸ¢é‡ä½ç§»</div>
                            <div class="value" id="max-disp">--</div>
                            <div class="unit">mm</div>
                        </div>
                        <div class="result-card warning">
                            <div class="label">æœ€å¤§æ”¯åº§å˜å½¢</div>
                            <div class="value" id="max-bearing">--</div>
                            <div class="unit">mm</div>
                        </div>
                        <div class="result-card" style="grid-column: span 2;">
                            <div class="label">æ”¾å¤§ç³»æ•° (max_accel / PGA)</div>
                            <div class="value" id="amp2">--</div>
                            <div class="unit">å€</div>
                        </div>
                    </div>
                </div>

                <div class="charts-row">
                    <div class="chart-container">
                        <h4>è¾“å…¥åœ°éœ‡åŠ¨ (g)</h4>
                        <canvas id="inputChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4>éš”éœ‡å±‚å˜å½¢ (mm)</h4>
                        <canvas id="dispChart"></canvas>
                    </div>
                </div>
                <div class="charts-row">
                    <div class="chart-container">
                        <h4>åŠ é€Ÿåº¦å“åº” (g)</h4>
                        <canvas id="accelChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4>æ‰­è½¬è§’ (mrad)</h4>
                        <canvas id="rotChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h4>ä½ç§»è½¨è¿¹
                        <select id="compare-bearing" style="float:right;font-size:0.65rem;padding:2px;">
                            <option value="">è´¨å¿ƒ</option>
                            <option value="8">vs æ”¯åº§8(å·¦ä¸Š)</option>
                            <option value="25">vs æ”¯åº§25(å³ä¸Š)</option>
                            <option value="30">vs æ”¯åº§30(å³ä¸‹)</option>
                            <option value="4">vs æ”¯åº§4(å·¦ä¸‹)</option>
                        </select>
                        <button id="btn-animate"
                            style="float:right;padding:2px 6px;font-size:0.65rem;cursor:pointer;margin-right:5px;">â–¶
                            åŠ¨ç”»</button>
                    </h4>
                    <canvas id="trajectoryChart" style="height:180px !important;"></canvas>
                    <div style="font-size:0.6rem;color:#888;margin-top:3px;" id="trajectory-legend">
                        <span style="color:#00d4ff;">â” </span>è´¨å¿ƒè½¨è¿¹
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ ¹æ®å½“å‰ç¯å¢ƒç¡®å®šAPIåœ°å€
        const API = window.location.protocol === 'file:'
            ? 'http://localhost:5050'  // æœ¬åœ°æ–‡ä»¶è®¿é—®
            : '';  // äº‘ç«¯éƒ¨ç½²ï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„
        let staticResult = null;  // ä¿å­˜é™åŠ›å­¦ç»“æœ
        let dynamicResult = null;
        let currentGM = 'sine';
        let bearingMode = 'physical';  // 'physical' or 'direct'

        // è®¡ç®—çš„åˆšåº¦å€¼
        let calcEdgeKv = 5520, calcEdgeKh = 55.2;
        let calcMidKv = 13475, calcMidKh = 134.75;

        // æ”¯åº§ä½ç½®åç§°
        const SUPPORT_NAMES = {
            '8': 'å·¦ä¸Š', '11': 'ä¸­ä¸Š', '25': 'å³ä¸Š',
            '4': 'å·¦ä¸‹', '16': 'ä¸­ä¸‹', '30': 'å³ä¸‹'
        };

        // åˆ‡æ¢è¾“å…¥æ¨¡å¼
        function toggleBearingMode() {
            if (bearingMode === 'physical') {
                bearingMode = 'direct';
                document.getElementById('mode-physical').style.display = 'none';
                document.getElementById('mode-direct').style.display = 'block';
                document.getElementById('btn-mode').textContent = 'ç‰©ç†å‚æ•°';
            } else {
                bearingMode = 'physical';
                document.getElementById('mode-physical').style.display = 'block';
                document.getElementById('mode-direct').style.display = 'none';
                document.getElementById('btn-mode').textContent = 'åˆ‡æ¢æ¨¡å¼';
            }
        }

        // è®¡ç®—æ”¯åº§åˆšåº¦ï¼ˆåŸºäºç‰©ç†å‚æ•°ï¼‰
        function calcBearingStiffness() {
            const edgeDiameter = parseFloat(document.getElementById('edge-diameter').value) / 1000;  // m
            const midDiameter = parseFloat(document.getElementById('mid-diameter').value) / 1000;
            const edgeLayers = parseFloat(document.getElementById('edge-layers').value);
            const midLayers = parseFloat(document.getElementById('mid-layers').value);
            const rubberLayerT = parseFloat(document.getElementById('rubber-layer-t').value) / 1000;  // m
            const G = parseFloat(document.getElementById('shear-modulus').value) * 1000;  // kN/mÂ² (MPa -> kN/mÂ²)

            // è¾¹ç¼˜æ”¯åº§
            const edgeArea = Math.PI * Math.pow(edgeDiameter / 2, 2);  // mÂ²
            const edgeTotalT = rubberLayerT * edgeLayers;  // æ€»æ©¡èƒ¶åšåº¦
            const edgeS = edgeDiameter / (4 * rubberLayerT);  // å½¢çŠ¶ç³»æ•° S = D/(4*tr)

            // æ°´å¹³åˆšåº¦ Kh0 = G Ã— A / Tr
            calcEdgeKh = G * edgeArea / edgeTotalT;
            // ç­‰æ•ˆå‹ç¼©æ¨¡é‡ Ec = 6 Ã— G Ã— SÂ²
            const edgeEc = 6 * G * edgeS * edgeS;
            // ç«–å‘åˆšåº¦ Kv = Ec Ã— A / Tr
            calcEdgeKv = edgeEc * edgeArea / edgeTotalT;

            // ä¸­é—´æ”¯åº§
            const midArea = Math.PI * Math.pow(midDiameter / 2, 2);
            const midTotalT = rubberLayerT * midLayers;
            const midS = midDiameter / (4 * rubberLayerT);

            calcMidKh = G * midArea / midTotalT;
            const midEc = 6 * G * midS * midS;
            calcMidKv = midEc * midArea / midTotalT;

            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('calc-edge-kv').textContent = calcEdgeKv.toFixed(0);
            document.getElementById('calc-edge-kh').textContent = calcEdgeKh.toFixed(1);
            document.getElementById('calc-mid-kv').textContent = calcMidKv.toFixed(0);
            document.getElementById('calc-mid-kh').textContent = calcMidKh.toFixed(1);

            // åŒæ—¶æ›´æ–°ç›´æ¥è¾“å…¥æ¡†ï¼ˆä¿æŒåŒæ­¥ï¼‰
            document.getElementById('edge-kv').value = calcEdgeKv.toFixed(0);
            document.getElementById('edge-kh').value = calcEdgeKh.toFixed(1);
            document.getElementById('mid-kv').value = calcMidKv.toFixed(0);
            document.getElementById('mid-kh').value = calcMidKh.toFixed(1);
        }

        async function checkHealth() {
            try {
                const r = await fetch(`${API}/api/health`);
                document.getElementById('status-bar').className = 'status-bar connected';
                document.getElementById('status-bar').textContent = 'OpenSees: å·²è¿æ¥';
            } catch (e) {
                document.getElementById('status-bar').className = 'status-bar disconnected';
                document.getElementById('status-bar').textContent = 'OpenSees: æœªè¿æ¥';
            }
        }

        function getSupports() {
            const sx = parseFloat(document.getElementById('spacing-x').value);  // Xæ–¹å‘é—´è·
            const sy = parseFloat(document.getElementById('spacing-y').value);  // Yæ–¹å‘é—´è·
            const edgeKv = parseFloat(document.getElementById('edge-kv').value);
            const midKv = parseFloat(document.getElementById('mid-kv').value);
            const edgeKh = parseFloat(document.getElementById('edge-kh').value);
            const midKh = parseFloat(document.getElementById('mid-kh').value);

            // è®¡ç®—æ”¯åº§é¢ç§¯ï¼ˆç”¨äºKh_effectiveéçº¿æ€§å…¬å¼ï¼‰
            let edgeArea = 0, midArea = 0;
            if (bearingMode === 'physical') {
                const edgeDiameter = parseFloat(document.getElementById('edge-diameter').value) / 1000;
                const midDiameter = parseFloat(document.getElementById('mid-diameter').value) / 1000;
                edgeArea = Math.PI * Math.pow(edgeDiameter / 2, 2);
                midArea = Math.PI * Math.pow(midDiameter / 2, 2);
            }

            // æ”¯åº§ä½ç½®åŸºäºé—´è·è®¡ç®—
            // å¸ƒç½®: 2è¡ŒÃ—3åˆ—
            //   å·¦(-sx)  ä¸­(0)  å³(+sx)
            // ä¸Š(+sy)  8      11     25
            // ä¸‹(-sy)  4      16     30
            return {
                '8': { x: -sx, y: sy, Kv: edgeKv, Kh: edgeKh, area: edgeArea, pos: 'å·¦ä¸Š' },
                '11': { x: 0, y: sy, Kv: midKv, Kh: midKh, area: midArea, pos: 'ä¸­ä¸Š' },
                '25': { x: sx, y: sy, Kv: edgeKv, Kh: edgeKh, area: edgeArea, pos: 'å³ä¸Š' },
                '4': { x: -sx, y: -sy, Kv: edgeKv, Kh: edgeKh, area: edgeArea, pos: 'å·¦ä¸‹' },
                '16': { x: 0, y: -sy, Kv: midKv, Kh: midKh, area: midArea, pos: 'ä¸­ä¸‹' },
                '30': { x: sx, y: -sy, Kv: edgeKv, Kh: edgeKh, area: edgeArea, pos: 'å³ä¸‹' }
            };
        }

        function getHeights() {
            return {
                '8': parseFloat(document.getElementById('h8').value),
                '11': parseFloat(document.getElementById('h11').value),
                '25': parseFloat(document.getElementById('h25').value),
                '4': parseFloat(document.getElementById('h4').value),
                '16': parseFloat(document.getElementById('h16').value),
                '30': parseFloat(document.getElementById('h30').value)
            };
        }

        async function runStatic() {
            const btn = document.getElementById('btn-static');
            btn.disabled = true;
            btn.textContent = 'â³ åˆ†æä¸­...';

            try {
                const r = await fetch(`${API}/api/calculate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        supports: getSupports(),
                        total_weight: parseFloat(document.getElementById('total-weight').value),
                        heights: getHeights()
                    })
                });
                const data = await r.json();
                console.log('é™åŠ›åˆ†æè¿”å›:', data);

                if (data.success) {
                    staticResult = data;

                    // æ˜¾ç¤ºåˆšåº¦ä¸­å¿ƒå’Œåå¿ƒï¼ˆåŸºäºç­‰æ•ˆKhï¼Œä¼šéšé«˜åº¦å˜åŒ–ï¼‰
                    const sc = data.stiffness_center || { x: 0, y: 0 };
                    const ecc = data.eccentricity || { x: 0, y: 0, magnitude: 0 };

                    document.getElementById('sc-x').textContent = sc.x.toFixed(4);
                    document.getElementById('sc-y').textContent = sc.y.toFixed(4);
                    document.getElementById('ecc').textContent = ecc.magnitude.toFixed(4);
                    document.getElementById('ecc-text').textContent = `åå¿ƒ: ${ecc.magnitude.toFixed(4)}m`;

                    // æ›´æ–°åå¿ƒå›¾ï¼ˆåˆšåº¦ä¸­å¿ƒä½ç½®ï¼‰
                    const scEl = document.getElementById('ecc-sc');
                    // æ”¾å¤§æ˜¾ç¤ºï¼Œç”¨2å€å› å­ä½¿å°åå¿ƒä¹Ÿèƒ½æ¸…æ™°çœ‹åˆ°
                    scEl.style.left = (50 + sc.x * 200) + '%';
                    scEl.style.top = (50 - sc.y * 200) + '%';

                    // æ˜¾ç¤ºç­‰æ•ˆæ€»åˆšåº¦
                    const totalKh = data.total_kh_effective || 490;
                    document.getElementById('total-kh').textContent = totalKh.toFixed(1);

                    // æ˜¾ç¤ºååŠ›
                    Object.entries(data.reactions).forEach(([sid, r]) => {
                        const el = document.getElementById('r' + sid);
                        if (el) el.textContent = r.toFixed(2);
                    });

                    // å¯ç”¨åŠ¨åŠ›åˆ†ææŒ‰é’®
                    document.getElementById('btn-dynamic').disabled = false;
                    document.getElementById('btn-dynamic').textContent = 'ğŸŒŠ è¿è¡ŒåŠ¨åŠ›åˆ†æ';
                    document.getElementById('status-text').textContent = `é™åŠ›åˆ†æå®Œæˆï¼Œåˆšåº¦åå¿ƒ=${ecc.magnitude.toFixed(4)}m`;
                } else {
                    // åˆ†æå¤±è´¥
                    document.getElementById('status-text').textContent = 'åˆ†æå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯');
                    console.error('åˆ†æå¤±è´¥:', data);
                }
            } catch (e) {
                console.error('è¯·æ±‚é”™è¯¯:', e);
                document.getElementById('status-text').textContent = 'é™åŠ›åˆ†æå¤±è´¥: ' + e.message;
            }

            btn.disabled = false;
            btn.textContent = 'ğŸ“ è¿è¡Œé™åŠ›åˆ†æ';
        }

        function generateGM(type, pga, period, duration, dt) {
            const freq = 1 / period;
            const n = Math.floor(duration / dt);
            let ax = [], ay = [];

            // å…ˆç”ŸæˆåŸå§‹æ³¢å½¢
            for (let i = 0; i < n; i++) {
                const t = i * dt;
                const env = Math.sin(Math.PI * t / duration);
                let accX = 0, accY = 0;
                switch (type) {
                    case 'sine':
                        accX = env * Math.sin(2 * Math.PI * freq * t);
                        accY = env * 0.7 * Math.sin(2 * Math.PI * freq * t + 0.5);
                        break;
                    case 'elcentro':
                        // El Centroé£æ ¼ï¼šå¤šé¢‘æˆåˆ†ï¼Œå¿«é€Ÿè¡°å‡
                        const t1 = 1, t2 = 3;
                        let envEC = t < t1 ? t / t1 : (t < t2 ? 1 : Math.exp(-(t - t2) / 2));
                        accX = envEC * (Math.sin(2 * Math.PI * freq * t) + 0.5 * Math.sin(2 * Math.PI * freq * 0.4 * t));
                        accY = envEC * 0.7 * Math.sin(2 * Math.PI * freq * 0.8 * t + 0.3);
                        break;
                    case 'pulse':
                        if (t > 0.2 * period && t < 1.2 * period) accX = Math.sin(Math.PI * (t - 0.2 * period) / period);
                        if (t > 0.5 * period && t < 1.5 * period) accY = 0.8 * Math.sin(Math.PI * (t - 0.5 * period) / period);
                        break;
                }
                ax.push(accX);
                ay.push(accY);
            }

            // å½’ä¸€åŒ–åˆ°æŒ‡å®šçš„PGA
            const maxX = Math.max(...ax.map(Math.abs)) || 1;
            const maxY = Math.max(...ay.map(Math.abs)) || 1;
            ax = ax.map(v => v / maxX * pga);
            ay = ay.map(v => v / maxY * pga * 0.7);  // Yæ–¹å‘ä¸ºXæ–¹å‘çš„70%

            return { ax, ay };
        }

        async function runDynamic() {
            if (!staticResult) {
                alert('è¯·å…ˆè¿è¡Œé™åŠ›åˆ†æ');
                return;
            }

            const btn = document.getElementById('btn-dynamic');
            btn.disabled = true;
            btn.textContent = 'â³ åŠ¨åŠ›åˆ†æä¸­...';

            try {
                const pga = parseFloat(document.getElementById('pga').value);
                const period = parseFloat(document.getElementById('gm-period').value);
                const duration = parseFloat(document.getElementById('duration').value);
                const dt = parseFloat(document.getElementById('dt').value);

                console.log('=== åŠ¨åŠ›åˆ†æå‚æ•° ===');
                console.log('PGA:', pga, 'g');
                console.log('è¾“å…¥å‘¨æœŸ:', period, 's');
                console.log('æŒæ—¶:', duration, 's');
                console.log('dt:', dt, 's');

                const gm = generateGM(currentGM, pga, period, duration, dt);
                const pgaActual = Math.max(...gm.ax.map(Math.abs));
                console.log('ç”Ÿæˆçš„åœ°éœ‡åŠ¨ PGA:', pgaActual.toFixed(3), 'g');
                console.log('åœ°éœ‡åŠ¨ç‚¹æ•°:', gm.ax.length);

                drawChart(document.getElementById('inputChart'), [gm.ax, gm.ay], ['X', 'Y'], ['#ff6b6b', '#00ff88'], duration);

                // ä½¿ç”¨é™åŠ›å­¦å¾—åˆ°çš„åˆšåº¦ä¸­å¿ƒä½œä¸ºåå¿ƒ
                const sc = staticResult.stiffness_center || { x: 0, y: 0 };
                const ecc = staticResult.eccentricity || { x: 0, y: 0, magnitude: 0 };

                // è´¨å¿ƒä½ç½® = -åˆšåº¦ä¸­å¿ƒåç§»ï¼ˆè¿™æ ·è´¨å¿ƒç›¸å¯¹åˆšåº¦ä¸­å¿ƒæœ‰åå¿ƒï¼‰
                const massCenterX = -sc.x;
                const massCenterY = -sc.y;
                console.log('è´¨å¿ƒåç§»:', massCenterX.toFixed(4), massCenterY.toFixed(4));

                const requestBody = {
                    supports: getSupports(),
                    total_weight: parseFloat(document.getElementById('total-weight').value),
                    heights: getHeights(),
                    ground_motion: gm,
                    dt, duration,
                    mass_center: { x: massCenterX, y: massCenterY }
                };
                console.log('è¯·æ±‚ä½“:', JSON.stringify(requestBody).substring(0, 500) + '...');

                const r = await fetch(`${API}/api/dynamic`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await r.json();
                dynamicResult = data;

                console.log('=== åç«¯è¿”å›æ•°æ® ===');
                console.log('æˆåŠŸ:', data.success);
                console.log('ç»“æ„å‘¨æœŸ:', data.period_x);
                console.log('PGA_x:', data.pga_x);
                console.log('æœ€å¤§åŠ é€Ÿåº¦:', data.max_accel_x);
                console.log('æ”¾å¤§ç³»æ•°:', data.amplification_x);
                console.log('æœ€å¤§ä½ç§»:', data.max_disp);

                if (data.success) {
                    // åŠ¨åŠ›ç‰¹æ€§
                    document.getElementById('period-x').textContent = data.period_x.toFixed(3);
                    document.getElementById('period-theta').textContent = data.period_theta.toFixed(3);
                    document.getElementById('period-ratio').textContent = data.period_ratio.toFixed(2);
                    document.getElementById('amp').textContent = data.amplification_x.toFixed(2);

                    // å³°å€¼å“åº” - è´¨å¿ƒä½ç§»
                    document.getElementById('max-disp-x').textContent = data.max_disp_x.toFixed(1);
                    document.getElementById('max-disp-y').textContent = data.max_disp_y.toFixed(1);
                    document.getElementById('max-disp').textContent = data.max_disp.toFixed(1);
                    document.getElementById('max-accel').textContent = data.max_accel.toFixed(3);
                    document.getElementById('max-rot').textContent = data.max_rot_z.toFixed(2);
                    document.getElementById('amp2').textContent = data.amplification_x.toFixed(2);

                    // æ”¯åº§å˜å½¢
                    let maxBearing = 0;
                    Object.entries(data.bearing_max || {}).forEach(([sid, b]) => {
                        const el = document.getElementById('b' + sid);
                        if (el) el.textContent = b.mag.toFixed(1);
                        if (b.mag > maxBearing) maxBearing = b.mag;
                    });
                    document.getElementById('max-bearing').textContent = maxBearing.toFixed(1);

                    // å›¾è¡¨ (ä¼ å…¥durationç”¨äºXè½´æ ‡ç­¾)
                    const dur = parseFloat(document.getElementById('duration').value);
                    drawChart(document.getElementById('dispChart'), [data.center_disp_x, data.center_disp_y], ['X', 'Y'], ['#00d4ff', '#00ff88'], dur);
                    drawChart(document.getElementById('accelChart'), [data.center_accel_x, data.center_accel_y], ['X', 'Y'], ['#00d4ff', '#00ff88'], dur);
                    drawChart(document.getElementById('rotChart'), [data.center_rot_z], ['Î¸z'], ['#ff6b6b'], dur);

                    // ç»˜åˆ¶è½¨è¿¹ï¼ˆæ ¹æ®é€‰æ‹©çš„å¯¹æ¯”æ”¯åº§ï¼‰
                    updateTrajectory();

                    document.getElementById('status-text').textContent = `åŠ¨åŠ›åˆ†æå®Œæˆ (${data.time.length}æ­¥) | è¾“å…¥å‘¨æœŸ=${period}s | æ”¾å¤§=${data.amplification_x.toFixed(2)}`;
                }
            } catch (e) {
                document.getElementById('status-text').textContent = 'åŠ¨åŠ›åˆ†æå¤±è´¥: ' + e.message;
            }

            btn.disabled = false;
            btn.textContent = 'ğŸŒŠ è¿è¡ŒåŠ¨åŠ›åˆ†æ';
        }

        function drawChart(canvas, datasets, labels, colors, duration) {
            const ctx = canvas.getContext('2d');
            const w = canvas.width = canvas.offsetWidth * 2;
            const h = canvas.height = canvas.offsetHeight * 2;
            ctx.scale(2, 2);
            const cw = canvas.offsetWidth, ch = canvas.offsetHeight;
            const pad = { left: 40, right: 10, top: 15, bottom: 25 };
            const plotW = cw - pad.left - pad.right;
            const plotH = ch - pad.top - pad.bottom;
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.fillRect(0, 0, cw, ch);

            let maxVal = 0.001;
            datasets.forEach(s => s && s.forEach(v => { if (Math.abs(v) > maxVal) maxVal = Math.abs(v); }));
            // è°ƒæ•´åˆ°å¥½çœ‹çš„åˆ»åº¦
            maxVal = Math.ceil(maxVal * 10) / 10;
            if (maxVal < 0.1) maxVal = 0.1;

            // ç»˜åˆ¶åæ ‡è½´
            ctx.strokeStyle = 'rgba(255,255,255,0.3)';
            ctx.lineWidth = 0.5;
            // Yè½´
            ctx.beginPath();
            ctx.moveTo(pad.left, pad.top);
            ctx.lineTo(pad.left, pad.top + plotH);
            ctx.stroke();
            // Xè½´ (ä¸­å¤®)
            ctx.beginPath();
            ctx.moveTo(pad.left, pad.top + plotH / 2);
            ctx.lineTo(cw - pad.right, pad.top + plotH / 2);
            ctx.stroke();
            // Xè½´åº•éƒ¨
            ctx.beginPath();
            ctx.moveTo(pad.left, pad.top + plotH);
            ctx.lineTo(cw - pad.right, pad.top + plotH);
            ctx.stroke();

            // Yè½´åˆ»åº¦
            ctx.fillStyle = '#888';
            ctx.font = '8px sans-serif';
            ctx.textAlign = 'right';
            ctx.fillText(maxVal.toFixed(2), pad.left - 3, pad.top + 4);
            ctx.fillText('0', pad.left - 3, pad.top + plotH / 2 + 3);
            ctx.fillText((-maxVal).toFixed(2), pad.left - 3, pad.top + plotH);

            // ç»˜åˆ¶ç½‘æ ¼çº¿
            ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            [0.25, 0.5, 0.75].forEach(r => {
                ctx.beginPath();
                ctx.moveTo(pad.left, pad.top + plotH * r);
                ctx.lineTo(cw - pad.right, pad.top + plotH * r);
                ctx.stroke();
            });

            // ç»˜åˆ¶æ•°æ®
            datasets.forEach((series, idx) => {
                if (!series || !series.length) return;
                ctx.strokeStyle = colors[idx] || '#00d4ff';
                ctx.lineWidth = 1;
                ctx.beginPath();
                for (let i = 0; i < series.length; i++) {
                    const x = pad.left + (i / series.length) * plotW;
                    const y = pad.top + plotH / 2 - (series[i] / maxVal) * (plotH / 2);
                    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                }
                ctx.stroke();
            });

            // å›¾ä¾‹
            ctx.textAlign = 'left';
            labels.forEach((l, i) => {
                ctx.fillStyle = colors[i];
                ctx.fillText(l, pad.left + i * 30, ch - 5);
            });

            // Xè½´æ ‡ç­¾ (æ—¶é—´)
            ctx.fillStyle = '#666';
            ctx.textAlign = 'right';
            const dataLen = datasets[0] ? datasets[0].length : 0;
            const dur = duration || (dataLen * 0.02);
            ctx.fillText(dur.toFixed(1) + 's', cw - pad.right, ch - 5);
        }

        function drawTrajectory(canvas, dispX, dispY, bearingX, bearingY) {
            const ctx = canvas.getContext('2d');
            const w = canvas.width = canvas.offsetWidth * 2;
            const h = canvas.height = canvas.offsetHeight * 2;
            ctx.scale(2, 2);
            const cw = canvas.offsetWidth, ch = canvas.offsetHeight;
            const cx = cw / 2, cy = ch / 2;
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.fillRect(0, 0, cw, ch);

            if (!dispX || !dispX.length) return;

            // è®¡ç®—æœ€å¤§å€¼æ—¶åŒ…æ‹¬æ”¯åº§ä½ç§»
            let maxVal = 1;
            dispX.forEach(v => { if (Math.abs(v) > maxVal) maxVal = Math.abs(v); });
            dispY.forEach(v => { if (Math.abs(v) > maxVal) maxVal = Math.abs(v); });
            if (bearingX) bearingX.forEach(v => { if (Math.abs(v) > maxVal) maxVal = Math.abs(v); });
            if (bearingY) bearingY.forEach(v => { if (Math.abs(v) > maxVal) maxVal = Math.abs(v); });
            const scale = (Math.min(cw, ch) / 2 - 20) / maxVal;

            // åæ ‡è½´
            ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            ctx.lineWidth = 0.5;
            ctx.beginPath();
            ctx.moveTo(20, cy); ctx.lineTo(cw - 20, cy);
            ctx.moveTo(cx, 20); ctx.lineTo(cx, ch - 20);
            ctx.stroke();

            // åˆ»åº¦
            ctx.fillStyle = '#666';
            ctx.font = '8px sans-serif';
            ctx.textAlign = 'right';
            ctx.fillText(maxVal.toFixed(0) + 'mm', cw - 22, cy - 3);

            // ç»˜åˆ¶æ”¯åº§è½¨è¿¹ï¼ˆå¦‚æœæœ‰ï¼‰
            if (bearingX && bearingY && bearingX.length) {
                ctx.strokeStyle = 'rgba(255,107,107,0.7)';  // çº¢è‰²
                ctx.lineWidth = 1;
                ctx.beginPath();
                for (let i = 0; i < bearingX.length; i++) {
                    const x = cx + bearingX[i] * scale;
                    const y = cy - bearingY[i] * scale;
                    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                }
                ctx.stroke();
            }

            // ç»˜åˆ¶è´¨å¿ƒè½¨è¿¹
            ctx.strokeStyle = 'rgba(0,212,255,0.8)';  // é’è‰²
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            for (let i = 0; i < dispX.length; i++) {
                const x = cx + dispX[i] * scale;
                const y = cy - dispY[i] * scale;
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            }
            ctx.stroke();
        }

        // æ»‘å—æ›´æ–°
        ['8', '11', '25', '4', '16', '30'].forEach(sid => {
            const slider = document.getElementById('h' + sid);
            const valEl = document.getElementById('h' + sid + '-val');
            slider.addEventListener('input', () => {
                valEl.textContent = parseFloat(slider.value).toFixed(1);
            });
        });

        // åœ°éœ‡åŠ¨ç±»å‹é€‰æ‹©
        document.querySelectorAll('.gm-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                document.querySelectorAll('.gm-chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                currentGM = chip.dataset.gm;
            });
        });

        // æ›´æ–°è½¨è¿¹å›¾ï¼ˆè´¨å¿ƒ+å¯é€‰æ”¯åº§å¯¹æ¯”ï¼‰
        function updateTrajectory() {
            if (!dynamicResult) return;
            const canvas = document.getElementById('trajectoryChart');
            const centerX = dynamicResult.center_disp_x;
            const centerY = dynamicResult.center_disp_y;

            const bearingId = document.getElementById('compare-bearing').value;
            let bearingX = null, bearingY = null;
            let legendText = '<span style="color:#00d4ff;">â” </span>è´¨å¿ƒè½¨è¿¹';

            if (bearingId && dynamicResult.bearing_disp && dynamicResult.bearing_disp[bearingId]) {
                const bd = dynamicResult.bearing_disp[bearingId];
                bearingX = bd.map(d => d.x);
                bearingY = bd.map(d => d.y);
                legendText += '  <span style="color:#ff6b6b;">â” </span>æ”¯åº§' + bearingId;
            }

            document.getElementById('trajectory-legend').innerHTML = legendText;
            drawTrajectory(canvas, centerX, centerY, bearingX, bearingY);
        }

        // æ”¯åº§å¯¹æ¯”é€‰æ‹©
        document.getElementById('compare-bearing').addEventListener('change', () => {
            updateTrajectory();
        });

        // åŠ¨ç”»
        let animId = null;
        document.getElementById('btn-animate').addEventListener('click', () => {
            if (!dynamicResult) return;
            const canvas = document.getElementById('trajectoryChart');
            const dispX = dynamicResult.center_disp_x;
            const dispY = dynamicResult.center_disp_y;

            if (animId) {
                cancelAnimationFrame(animId);
                animId = null;
                drawTrajectory(canvas, dispX, dispY);
                return;
            }

            let frame = 0;
            function animate() {
                drawTrajectory(canvas, dispX.slice(0, frame), dispY.slice(0, frame));
                frame += 3;
                if (frame < dispX.length) animId = requestAnimationFrame(animate);
                else { animId = null; drawTrajectory(canvas, dispX, dispY); }
            }
            animate();
        });

        document.getElementById('btn-static').addEventListener('click', runStatic);
        document.getElementById('btn-dynamic').addEventListener('click', runDynamic);

        checkHealth();
        calcBearingStiffness();  // é¡µé¢åŠ è½½æ—¶è®¡ç®—åˆšåº¦
    </script>
</body>

</html>